<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Notebook LM – </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Bootstrap base -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- CSS personalizzato -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app" class="page-shell">
    <!-- Hero / intestazione -->
    <section class="hero-card mb-3">
      <div class="hero-pill">
        <span class="hero-pill-dot"></span>
        <span>LM Notebooks Board</span>
      </div>

      <h1 class="hero-title">Notebook LM – Informatica, SER, TEPI</h1>
      <p class="hero-subtitle">
        Un unico spazio dove studenti e studentesse trovano i notebook organizzati
        per anno, classe e lezione, con breve descrizione e data.
      </p>

      <div class="hero-badges">
        <span class="hero-badge">
          <strong>{{ totalYears }}</strong>&nbsp;anni scolastici
        </span>
        <span class="hero-badge">
          <strong>{{ totalClasses }}</strong>&nbsp;classi
        </span>
        <span class="hero-badge">
          <strong>{{ totalLessons }}</strong>&nbsp;lezioni
        </span>
      </div>
    </section>

    <!-- Pannello filtri -->
    <section class="panel">
      <div class="row g-3 align-items-start">
        <div class="col-md-4">
          <div class="filter-label">Anno</div>
          <select
            class="form-select"
            v-model="selectedYear"
          >
            <option value="">Tutti gli anni</option>
            <option
              v-for="year in orderedYears"
              :key="year"
              :value="year"
            >
              {{ year }}
            </option>
          </select>
        </div>

        <div class="col-md-8">
          <div class="filter-label">Ricerca veloce</div>
          <input
            type="text"
            class="form-control"
            placeholder="Cerca nel titolo o nella descrizione (es. 'Algoritmi', 'Reti', 'NotebookLM')"
            v-model="searchQuery"
          />
          <div class="quick-filters">
            <span
              class="quick-chip"
              @click="searchQuery = 'introduzione'"
            >
              Introduzione
            </span>
            <span
              class="quick-chip"
              @click="searchQuery = 'algoritmi'"
            >
              Algoritmi
            </span>
            <span
              class="quick-chip"
              @click="searchQuery = 'reti'"
            >
              Reti
            </span>
            <span
              class="quick-chip"
              @click="searchQuery = ''"
            >
              Azzera filtri
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- Stato di caricamento / errore -->
    <section class="mt-3 mb-2" v-if="loading || error">
      <div
        v-if="loading"
        class="alert alert-info"
        role="alert"
      >
        Caricamento dei dati dei notebook in corso.
      </div>
      <div
        v-else
        class="alert alert-danger"
        role="alert"
      >
        Errore nel caricamento dei dati dei notebook.
      </div>
    </section>

    <!-- Nessun risultato -->
    <section
      v-if="!loading && !error && filteredYears.length === 0"
      class="mt-3"
    >
      <div class="alert alert-warning" role="alert">
        Nessuna lezione trovata con i filtri correnti.
      </div>
    </section>

    <!-- Elenco anni / classi / lezioni -->
    <section v-if="!loading && !error">
      <div
        v-for="year in filteredYears"
        :key="year"
      >
        <div class="year-header">
          <div>
            <p class="year-title">Anno scolastico {{ year }}</p>
            <p class="year-meta mb-0">
              {{ Object.keys(data[year]).length }} classi in elenco
            </p>
          </div>
        </div>

        <div class="row">
          <div
            class="col-12"
            v-for="(lessons, className) in filteredClassesByYear(year)"
            :key="className"
          >
            <article class="class-card p-3">
              <header class="class-header">
                <h2 class="class-name">
                  <span class="class-tag">Classe {{ className }}</span>
                </h2>
                <div class="class-meta-badges">
                  <span class="chip chip-strong">
                    {{ lessons.length }} lezioni
                  </span>
                  <button
                    type="button"
                    class="toggle-btn"
                    @click="toggleClass(year, className)"
                  >
                    <span
                      class="toggle-icon"
                      :class="{ open: isClassOpen(year, className) }"
                    >
                      ▶
                    </span>
                    <span v-if="isClassOpen(year, className)">Nascondi</span>
                    <span v-else>Mostra</span>
                  </button>
                </div>
              </header>

              <ul
                class="lessons-list"
                v-if="isClassOpen(year, className)"
              >
                <li
                  v-for="lesson in lessons"
                  :key="year + '-' + className + '-' + lesson.title"
                  class="lesson-item"
                >
                  <a
                    class="lesson-link"
                    :href="lesson.url"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <span>{{ lesson.title }}</span>
                  </a>
                  <div class="lesson-meta">
                    <span v-if="lesson.date">
                      Data: {{ formatDate(lesson.date) }}
                    </span>
                    <span v-if="lesson.description">
                      {{ lesson.description }}
                    </span>
                  </div>
                </li>
              </ul>

              <p
                v-else
                class="lessons-collapsed-text mb-0"
              >
                Lezioni nascoste. Clicca su “Mostra” per vedere l’elenco.
              </p>
            </article>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Vue 3 via CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          data: {},          // dati grezzi da lm-data.json
          loading: true,
          error: false,
          selectedYear: "",  // filtro anno
          searchQuery: "",   // filtro testo
          openClasses: {}    // stato open/closed per ogni classe
        };
      },
      computed: {
        orderedYears() {
          return Object.keys(this.data)
            .sort()
            .reverse();
        },
        filteredYears() {
          let years = this.selectedYear
            ? [this.selectedYear]
            : this.orderedYears;

          if (!this.searchQuery.trim()) {
            return years;
          }

          const q = this.searchQuery.toLowerCase();

          return years.filter(year => {
            const classes = this.data[year];
            return Object.keys(classes).some(className => {
              return classes[className].some(lesson =>
                (lesson.title && lesson.title.toLowerCase().includes(q)) ||
                (lesson.description && lesson.description.toLowerCase().includes(q))
              );
            });
          });
        },
        totalYears() {
          return Object.keys(this.data).length || 0;
        },
        totalClasses() {
          return Object.values(this.data).reduce((acc, classesObj) => {
            return acc + Object.keys(classesObj).length;
          }, 0);
        },
        totalLessons() {
          return Object.values(this.data).reduce((acc, classesObj) => {
            return acc + Object.values(classesObj).reduce((innerAcc, lessons) => innerAcc + lessons.length, 0);
          }, 0);
        }
      },
      methods: {
        keyForClass(year, className) {
          return `${year}::${className}`;
        },
        isClassOpen(year, className) {
          const key = this.keyForClass(year, className);
          // default = chiusa; è aperta solo se esplicitamente true
          return this.openClasses[key] === true;
        },
        toggleClass(year, className) {
          const key = this.keyForClass(year, className);
          const current = this.isClassOpen(year, className);
          this.openClasses = {
            ...this.openClasses,
            [key]: !current
          };
        },
        filteredClassesByYear(year) {
          const classes = this.data[year];
          const q = this.searchQuery.trim().toLowerCase();

          if (!q) {
            return classes;
          }

          const result = {};

          Object.keys(classes).forEach(className => {
            const lessons = classes[className].filter(lesson => {
              const inTitle = lesson.title &&
                lesson.title.toLowerCase().includes(q);
              const inDesc = lesson.description &&
                lesson.description.toLowerCase().includes(q);
              return inTitle || inDesc;
            });
            if (lessons.length > 0) {
              result[className] = lessons;
            }
          });

          return result;
        },
        formatDate(dateStr) {
          if (!dateStr) return "";

          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
            const [y, m, d] = dateStr.split("-").map(Number);
            const date = new Date(y, m - 1, d);
            return date.toLocaleDateString("it-IT", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit"
            });
          }

          return dateStr;
        }
      },
      created() {
        fetch("lm-data.json")
          .then(r => {
            if (!r.ok) throw new Error("HTTP error " + r.status);
            return r.json();
          })
          .then(json => {
            this.data = json;
            this.loading = false;
          })
          .catch(err => {
            console.error(err);
            this.error = true;
            this.loading = false;
          });
      }
    }).mount("#app");
  </script>
</body>
</html>
